<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">


<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
<script src="js/simplify.js"></script>
<script src="js/default_sketch.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script>
$(document).on("mobileinit", function() {
	console.log("mobileinit")
});
</script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<style>

canvas{
	position: absolute;
	left: 0px;
	bottom: 0px;
    right: 0px;
    top: 0px;
   background: #eee;
}

</style>

</head>

<body onload="clear();">

<canvas id="myCanvas"></canvas>

<div class='submitContainer'>
    <input id="input_submit" type="button" value="SUBMIT JOB" onclick="make()"/>
</div>

<img class="menu-icon" src="css/menu.png">
<div class="inputContainer">
    <label for="width">Canvas Width (X)</label>
    <input type="number" name="width" class="width" placeholder="Canvas Width (X)" value="4"/>
    <label for="width">Canvas Height (Y)</label>
    <input type="number" name="height"class="height" placeholder="Canvas Height (Y)" value="3"/>
    <label for="width">Cut Depth</label>
    <input type="number" name="depth"class="depth"  placeholder="Cut Depth" value="-0.04"/>
</div>
<script>

//hard coded settings
// Bill's mods

var SizeX = $('.width').val();
var SizeY = $('.height').val();
var CutDepth = $('.depth').val();

$('.width').change(function(){
    SizeX = $('.width').val();
});

$('.height').change(function(){
    SizeX = $('.height').val();
});

$('.depth').change(function(){
    SizeX = $('.depth').val();
});

//variables for setting mins and maxs
var MinX = 100000
var MaxX = -100000
var MinY = 100000
var MaxY = -100000
var DeltaX 
var DeltaY

// end Bill's mods
var SafeZ = 0.2
var g = ""
var points = []
var smooth = []
var endpts = []
var n = 0
var ts = 0
var sketch = false
var j
var i

function makeSmooth(){

//join

if(points[points.length-1].length>0){
	endpts.push([points[points.length-1][0]])
	endpts[endpts.length-1].push(points[points.length-1][points[points.length-1].length-1])
}

if((Math.abs(endpts[endpts.length-1][0].x-endpts[endpts.length-1][1].x)<=15) && (Math.abs(endpts[endpts.length-1][0].y-endpts[endpts.length-1][1].y)<=15)){

	endpts[endpts.length-1][1]=endpts[endpts.length-1][0]
	points[points.length-1].push(endpts[endpts.length-1][0])
	endpts.pop()
}

else{

for(i=endpts.length-2;i>=0;i--){

	if((Math.abs(endpts[endpts.length-1][0].x-endpts[i][0].x)<=15) && (Math.abs(endpts[endpts.length-1][0].y-endpts[i][0].y)<=15)){
		endpts[endpts.length-1][0]=endpts[i][0]
		points[points.length-1].splice(0,0,endpts[i][0])
	}
	
	if((Math.abs(endpts[endpts.length-1][1].x-endpts[i][1].x)<=15) && (Math.abs(endpts[endpts.length-1][1].y-endpts[i][1].y)<=15)){
		endpts[endpts.length-1][1]=endpts[i][1]
		points[points.length-1].push(endpts[i][1])
	}
	
	if((Math.abs(endpts[endpts.length-1][1].x-endpts[i][0].x)<=15) && (Math.abs(endpts[endpts.length-1][1].y-endpts[i][0].y)<=15)){
		endpts[endpts.length-1][1]=endpts[i][0]
		points[points.length-1].push(endpts[i][0])
	}
	
	if((Math.abs(endpts[endpts.length-1][0].x-endpts[i][1].x)<=15) && (Math.abs(endpts[endpts.length-1][0].y-endpts[i][1].y)<=15)){
		endpts[endpts.length-1][0]=endpts[i][1]
		points[points.length-1].splice(0,0,endpts[i][1])
	}

}


}

//simplify

points[points.length-1]=simplify(points[points.length-1], 4, true)
curve=points[points.length-1]
smooth.push([])

if(curve.length==1){
	smooth[points.length-1].push(curve[0])
}

//CHAIKIN'S ALGORITHM

if(curve.length>1){

	while(n<3){
		smooth[points.length-1].push(curve[0])
		for(i=0;i<curve.length-1;i++){
			var p0 = curve[i]
			var p1 = curve[i+1]
			var p0x = p0.x,
				p0y = p0.y,
				p1x = p1.x,
			    p1y = p1.y
				
				//Bill's mods
		if (p0x > MaxX){
            MaxX = p0x
        }
        else if (p0x < MinX) {
            MinX = p0x
        }
        else if (p0y > MaxY){
            MaxY = p0y 
        }
        else if (p0y < MinY) {
            MinY = p0y 
        };
		//end bill's mods
			smooth[points.length-1].push({x:(0.75*p0x+0.25*p1x),y:(0.75*p0y+0.25*p1y)})
			smooth[points.length-1].push({x:(0.25*p0x+0.75*p1x),y:(0.25*p0y+0.75*p1y)})
		}
		smooth[points.length-1].push(curve[curve.length-1])
		curve=smooth[points.length-1]
		smooth[points.length-1]=[]
		n++
	}
}

n=0
smooth[points.length-1]=curve

draw()

}

function draw(){

c = document.getElementById("myCanvas");
ctx = c.getContext("2d");

ctx.canvas.height = $(window).height()
ctx.canvas.width = $(window).width()

ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

ctx.lineWidth = 6;
ctx.strokeStyle = "#6495ed"
ctx.beginPath();
ctx.lineJoin="round"
ctx.lineCap="round"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
			if(j==0){
			ctx.moveTo(smooth[i][j].x,smooth[i][j].y)			
			}
			else{
			ctx.lineTo(smooth[i][j].x,smooth[i][j].y)
			}
		}
		ctx.stroke()
	}
	
}

//display points
/*
ctx.lineWidth = 1;
ctx.strokeStyle = "#000"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
		   ctx.beginPath();
			ctx.arc(smooth[i][j].x,smooth[i][j].y,2,0,2*Math.PI);
			ctx.stroke()
		}
	}
	
}
*/

ctx.lineWidth = 6;

}

$("#myCanvas").bind('vmousedown', function(e) {
    if ($('.inputContainer').data('open')== 'true'){    
        $('.inputContainer').css('right', '-1000px');
        $('.inputContainer').data('open', 'false');
    }//	console.log(e.type)
	if(smooth.length==0){
		ctx.translate(-ctx.canvas.width/2,-ctx.canvas.height/2);
		ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
	}
	ctx.beginPath();
	ctx.moveTo(e.clientX,e.clientY)
	sketch=true
	points.push([])
	ctx.strokeStyle = "#4169e1"
	points[points.length-1].push({x:e.clientX,y:e.clientY})
	e.preventDefault()
});


$("#myCanvas").bind('vmousemove', function(e) {
	if((sketch==true) && (typeof e.clientX != 'undefined')) {
		ctx.lineTo(e.clientX,e.clientY)
		
		// find min and max values
		/*Bill's mods
		if (e.clientX > MaxX){
            MaxX = e.clientX
        }
        else if (e.clientX < MinX) {
            MinX = e.clientX
        }
        else if (e.clientY > MaxY){
            MaxY = e.clientY 
        }
        else if (e.clientY < MinY) {
            MinY = e.clientY 
        };
		//end bill's mods
		*/
	   points[points.length-1].push({x:e.clientX,y:e.clientY})
	   ctx.stroke()
	}
	e.preventDefault()
});


$("#myCanvas").bind('vmouseup', function(e) {
	sketch=false
	makeSmooth()
	e.preventDefault()
});

$( "#myCanvas" ).bind('tap', function(e) {
	ts = e.timeStamp - ts
	console.log(ts)
	if((ts>0)&&(ts<200)){
		clear()
	}
	ts = e.timeStamp
	
});


$(window).resize(function(){
	clear()
}); 

function clear(){
   MinX = 100000
   MaxX = -100000
   MinY = 100000
   MaxY = -100000
   points=[]
   smooth=[]
   draw()

//	ctx.fillStyle="#6495ed"
//	ctx.font = "24px Arial";
//	ctx.fillText("sketch here",(ctx.canvas.width/2)-60,(ctx.canvas.height/2)+24);
//	ctx.translate(ctx.canvas.width/2,ctx.canvas.height/2);

ctx.translate(ctx.canvas.width/2,ctx.canvas.height/2);
ctx.moveTo(default_sketch[0][0].x,default_sketch[0][0].y)
i=0
j=0
animate()

}

function animate () {           
   setTimeout(function () {    
      ctx.lineTo(default_sketch[i][j].x,default_sketch[i][j].y)
		ctx.stroke()    
      j=j+2;                     
      if (j < default_sketch[i].length) {            
         animate();             
      }
		else if((j>=default_sketch[i].length) && (i<default_sketch.length-1)) {
			i++
			j=0
			ctx.moveTo(default_sketch[i][j].x,default_sketch[i][j].y)
			animate();
		}                        
   }, 1)
}


function make(){

//calculate scaling
//Bill's mods
    var Scale
    
    DeltaX = (MaxX - MinX)
    DeltaY = (MaxY - MinY)
    //console.log("DeltaX = " + DeltaX)
    //console.log("DeltaY = " + DeltaY)
    var ScaleFactorX = SizeX / DeltaX
    var ScaleFactorY = SizeY / DeltaY
    if (ScaleFactorX < ScaleFactorY) {
        Scale = ScaleFactorX
    }
    else {
        Scale = ScaleFactorY
    }
	//console.log(Scale)
	//end Bill's mods

var material = {feed:500,plunge:200}
var pass = 1
var pass_no=1
var pass_depth=1


//add test for inch/metric based on size of drawing
//Bill's mod

if (SizeX > 6){
	g+="g21\n"}
	else{
	g+="g20\n"
	};
	
g+="g0z " + SafeZ + "\n"

//end Bill's mods


g+="m4\n"
g+="g4p2\n"

while(pass<=pass_no){
   
   for(i=0;i<smooth.length;i++){
   
   //Bill's mods for scaling and position
   	//g+="g0x"+(smooth[i][0].x).toFixed(3) +"y"+ (smooth[i][0].y).toFixed(3) + "\n"
   	//g+="g1z-1f60\n"
   	//g+="g1f60\n"
   	//for(j=1;j<smooth[i].length;j++){
	 //     g+="g1x"+(smooth[i][j].x).toFixed(3) +"y"+ (smooth[i][j].y).toFixed(3) + "\n"
	//	}
	//	g+="g0z3\n"
	
	g+="g0x"+(((smooth[i][0].x) - MinX) * Scale) .toFixed(3)  +"y"+ ((DeltaY - ((smooth[i][0].y)- MinY)) * Scale).toFixed(3) + "\n"
   	g+="g1z " + CutDepth + "f60\n"
   	g+="g1f60\n"
   	for(j=1;j<smooth[i].length;j++){
	      g+="g1x"+(((smooth[i][j].x) - MinX) * Scale) .toFixed(3)  +"y"+ ((DeltaY - ((smooth[i][j].y) - MinY) )* Scale).toFixed(3)  + "\n"
			
		}
		g+="g0z " + SafeZ + "\n"
		
		// end Bill's mods
   }
   pass++
}

g+="m5\n"
g+="m30\n"

//console.log(g)

//define default sketch
/*
default_sketch=[]
for(i=0;i<smooth.length;i++){
	default_sketch.push(["["])
	for(j=0;j<smooth[i].length;j++){

		smooth[i][j].x = ((smooth[i][j].x) - (MinX + DeltaX/2)).toFixed(1)
		smooth[i][j].y = ((smooth[i][j].y) - (MinY+ DeltaY/2)).toFixed(1)

		default_sketch[i]+=(JSON.stringify(smooth[i][j])+",")
	}
		default_sketch[i]+=(["]"])
}

for(i=0;i<default_sketch.length;i++){
	console.log(default_sketch[i])
}
*/
//

fabmo.submitJob({
   file : g,
   filename : "sketch.g",
  name : "SKETCH",
   description : "Smooth Sketch"
});


g=""

}
$('.menu-icon').click(function(){
    if ($('.inputContainer').data('open')== 'true'){
        $('.inputContainer').css('right', '-1000px');
        $('.inputContainer').data('open', 'false');
    } else {
        $('.inputContainer').css('right', '10px');
        $('.inputContainer').data('open', 'true');
    }
});
</script>


</body>
</html>

