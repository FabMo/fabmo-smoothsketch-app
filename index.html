<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">

<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
<script src="js/simplify.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script>
$(document).on("mobileinit", function() {
	console.log("mobileinit")
});
</script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<style>

canvas{
	position: absolute;
	left: 0px;
	bottom: 0px;
   background: #555;
}



</style>

</head>

<body onload="draw();">

<canvas id="myCanvas"></canvas>

<div class='submitContainer'>
    <input id="input_submit" type="button" value="SUBMIT JOB" onclick="make()"/>
</div>
<img class="menu-icon" src="css/menu.png">
<div class="inputContainer">
    <label for="feedrate">FEEDRATE</label>
    <input type="number" name="feedrate" id="feedrate" step="10" value="600" autocomplete="on"/>
    <input type="submit" name="fullscreen" id="fullscreen" onclick="toggleFullScreen()" value="FULLSCREEN"/>
</div>
<script>

var g = ""
var points = []
var smooth = []
var curve = []
var endpts = []
var n = 0
var ts = 0
var sketch = false

var min_depth = 1
var max_depth = 1

var z = []

var xmin
var xmax
var ymin
var ymax
var zmin
var zmax

function makeSmooth(){


if(points[points.length-1].length>0){
	endpts.push([points[points.length-1][0]])
	endpts[endpts.length-1].push(points[points.length-1][points[points.length-1].length-1])
}

if((Math.abs(endpts[endpts.length-1][0].x-endpts[endpts.length-1][1].x)<=25) && (Math.abs(endpts[endpts.length-1][0].y-endpts[endpts.length-1][1].y)<=25)){

	endpts[endpts.length-1][1]=endpts[endpts.length-1][0]
	points[points.length-1].push(endpts[endpts.length-1][0])
	endpts.pop()
	//console.log(endpts)
}

else{

for(i=endpts.length-2;i>=0;i--){

	if((Math.abs(endpts[endpts.length-1][0].x-endpts[i][0].x)<=25) && (Math.abs(endpts[endpts.length-1][0].y-endpts[i][0].y)<=25)){
		endpts[endpts.length-1][0]=endpts[i][0]
		points[points.length-1].splice(0,0,endpts[i][0])
	}
	
	if((Math.abs(endpts[endpts.length-1][1].x-endpts[i][1].x)<=25) && (Math.abs(endpts[endpts.length-1][1].y-endpts[i][1].y)<=25)){
		endpts[endpts.length-1][1]=endpts[i][1]
		points[points.length-1].push(endpts[i][1])
	}
	
	if((Math.abs(endpts[endpts.length-1][1].x-endpts[i][0].x)<=25) && (Math.abs(endpts[endpts.length-1][1].y-endpts[i][0].y)<=25)){
		endpts[endpts.length-1][1]=endpts[i][0]
		points[points.length-1].push(endpts[i][0])
	}
	
	if((Math.abs(endpts[endpts.length-1][0].x-endpts[i][1].x)<=25) && (Math.abs(endpts[endpts.length-1][0].y-endpts[i][1].y)<=25)){
		endpts[endpts.length-1][0]=endpts[i][1]
		points[points.length-1].splice(0,0,endpts[i][1])
	}

}


}
//console.log(endpts)

//simplify

points[points.length-1]=simplify(points[points.length-1], 3, true)

curve=points[points.length-1]
smooth.push([])

if(curve.length==1){
	smooth[points.length-1].push(curve[0])
}

//CHAIKIN'S ALGORITHM

if(curve.length>2){

	while(n<=2){
		smooth[points.length-1].push(curve[0])
		for(i=0;i<curve.length-1;i++){
			var p0 = curve[i]
			var p1 = curve[i+1]
			var p0x = p0.x,
				 p0y = p0.y,
				 p1x = p1.x,
			    p1y = p1.y
			smooth[points.length-1].push({x:(0.75*p0x+0.25*p1x),y:(0.75*p0y+0.25*p1y)})
			smooth[points.length-1].push({x:(0.25*p0x+0.75*p1x),y:(0.25*p0y+0.75*p1y)})
		}
		smooth[points.length-1].push(curve[curve.length-1])
		curve=smooth[points.length-1]
		smooth[points.length-1]=[]
		n++
	}
	
}

n=0

smooth[points.length-1]=curve

if(typeof xmin == 'undefined'){

	xmin = Math.min.apply(this,$.map(curve, function(o){ return o.x; }))
	xmax = Math.max.apply(this,$.map(curve, function(o){ return o.x; }))
	ymin = Math.min.apply(this,$.map(curve, function(o){ return o.y; }))
	ymax = Math.max.apply(this,$.map(curve, function(o){ return o.y; }))

}

else{

	if((Math.min.apply(this,$.map(curve, function(o){ return o.x; })))<xmin){
		xmin = Math.min.apply(this,$.map(curve, function(o){ return o.x; }))
	}
	if((Math.max.apply(this,$.map(curve, function(o){ return o.x; })))>xmax){
		xmax = Math.max.apply(this,$.map(curve, function(o){ return o.x; }))
	}
	if((Math.min.apply(this,$.map(curve, function(o){ return o.y; })))<ymin){
		ymin = Math.min.apply(this,$.map(curve, function(o){ return o.y; }))
	}
	if((Math.max.apply(this,$.map(curve, function(o){ return o.y; })))>ymax){
		ymax = Math.max.apply(this,$.map(curve, function(o){ return o.y; }))
	}
	
}
//z

z=[]

for(i=0;i<smooth.length;i++){
	z.push([])
	for(j=0;j<smooth[i].length-1;j++){
		z[i].push({z:(max_depth/(max_depth*(1+(Math.sqrt(Math.pow((smooth[i][j].x-smooth[i][j+1].x),2)+Math.pow((smooth[i][j].y-smooth[i][j+1].y),2))))))})		
	}
z[i].push({z:(z[i][z[i].length-1]).z})

}
//console.log(z)

for(i=0;i<z.length;i++){

zmax = Math.max.apply(this,$.map(z[i], function(o){ return o.z; }))
zmin = Math.min.apply(this,$.map(z[i], function(o){ return o.z; }))

	for(j=0;j<z[i].length;j++){

	if(zmax!=zmin){
		z[i][j].z = parseFloat((((1/(zmax-zmin)) * (z[i][j].z-zmin))).toFixed(3))
	}
	else{
		//average speed
		z[i][j].z=0
	}
	}
}

//console.log(z)

//console.log(smooth)


draw()

}

function draw(){

c = document.getElementById("myCanvas");
ctx = c.getContext("2d")

ctx.canvas.height = $(window).height()
ctx.canvas.width = $(window).width()

ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);


ctx.beginPath()
ctx.fillStyle = "#333"
ctx.rect(xmin-10,ymin-10,xmax+20-xmin,ymax+20-ymin)
ctx.fill()

ctx.lineWidth = 10
ctx.strokeStyle = "#6495ed"
ctx.beginPath()
ctx.lineJoin="round"
ctx.lineCap="round"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
			if(j==0){
			ctx.moveTo(smooth[i][j].x,smooth[i][j].y)			
			}
			else{
			ctx.lineTo(smooth[i][j].x,smooth[i][j].y)
			}
		}
		ctx.stroke()
	}
	
}

ctx.lineWidth = 1
ctx.beginPath()
	ctx.strokeStyle = "#ccc"
	ctx.rect(xmin-10,ymin-10,xmax+20-xmin,ymax+20-ymin)
ctx.stroke()

ctx.fillStyle="rgba(255, 255, 255, 0.5)"

ctx.strokeStyle = "#555"
if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
		   ctx.beginPath();
			ctx.arc(smooth[i][j].x,smooth[i][j].y,2,0,2*Math.PI)
			ctx.stroke()
			ctx.fill()
		}
	}	
}


ctx.lineWidth = 1
ctx.fillStyle="#ff00ff"
ctx.strokeStyle = "#eee"

for(i=0;i<endpts.length;i++){
	ctx.beginPath()	
		ctx.arc(endpts[i][0].x,endpts[i][0].y,3,0,2*Math.PI)
	ctx.fill()
	ctx.stroke()
	ctx.beginPath()	
		ctx.arc(endpts[i][1].x,endpts[i][1].y,3,0,2*Math.PI)
	ctx.fill()
	ctx.stroke()
}
/*
ctx.beginPath()
	ctx.fillStyle = "#fff000"
	ctx.arc(xmin-10,ymax+10,2,0,2*Math.PI)
ctx.fill()
*/

ctx.lineWidth = 1
ctx.beginPath()
	ctx.strokeStyle = "#ccc"
//	ctx.rect(200,200,125,125)
ctx.stroke()


ctx.beginPath()
	ctx.fillStyle = "#fff"
	ctx.arc(xmin,ymax+10,1,0,2*Math.PI)
ctx.fill()

ctx.beginPath()
	ctx.fillStyle = "#fff"
	ctx.arc(xmax,ymax+10,1,0,2*Math.PI)
ctx.fill()

ctx.beginPath()
	ctx.fillStyle = "#fff"
	ctx.arc(xmin-10,ymax,1,0,2*Math.PI)
ctx.fill()

ctx.beginPath()
	ctx.fillStyle = "#fff"
	ctx.arc(xmin-10,ymin,1,0,2*Math.PI)
ctx.fill()



ctx.fillStyle='#ddd'
ctx.font = "16px Arial";
ctx.fillText((25.4*((xmax-xmin)/125.37)).toFixed(1) + " mm",(xmax)-((xmax-xmin)*0.5)-20,ymax+30);

//ctx.rotate(20*Math.PI/180);
ctx.fillText((25.4*((ymax-ymin)/125.37)).toFixed(1) + " mm",(xmin)-85,ymax-(ymax-ymin)/2);

}

$("#myCanvas").bind('vmousedown', function(e) {
    if ($('.inputContainer').data('open')== 'true'){    
        $('.inputContainer').css('right', '-1000px');
        $('.inputContainer').data('open', 'false');
   }

	ctx.beginPath();
	ctx.lineWidth = 10;
	ctx.moveTo(e.clientX,e.clientY)
	sketch=true
	points.push([])
	ctx.strokeStyle = "#4169e1"
	points[points.length-1].push({x:e.clientX,y:e.clientY})
	e.preventDefault()
});


$("#myCanvas").bind('vmousemove', function(e) {
	if((sketch==true) && (typeof e.clientX != 'undefined')) {
		ctx.lineTo(e.clientX,e.clientY)
	   points[points.length-1].push({x:e.clientX,y:e.clientY})
	   ctx.stroke()
	}
	e.preventDefault()
});


$("#myCanvas").bind('vmouseup', function(e) {
	sketch=false
	makeSmooth()
	e.preventDefault()
});

$( "#myCanvas" ).bind('tap', function(e) {
	ts = e.timeStamp - ts
	if(ts<250){
		clear()
	}
	ts = e.timeStamp
});

$(window).on("orientationchange", function() {
	draw()
});


$(window).resize(function(){

	draw()
}); 

function clear(){
	xmin = undefined
	xmax = undefined
	ymin = undefined
	ymax = undefined
   points=[]
   smooth=[]
   endpts=[]
   connect=[]
   draw()
}

function make(){



//scale 125.37 ppi
var sf = ((xmax-xmin)/(25.4*(xmax-xmin)/125.37))


g+="g21\n"
g+="g0z3\n"
g+="m4\n"
g+="g4p2\n"

for(i=0;i<smooth.length;i++){
   g+="g0x"+(((smooth[i][0].x)-xmin)/sf).toFixed(3) +"y"+ (((ymax-ymin)-((smooth[i][0].y))+ymin)/sf).toFixed(3) + "\n"
   g+="g1z-"+ (min_depth+(z[i][0].z)).toFixed(3) +"f" + (feedrate/2).toFixed(0) + "\n"
   g+="g1f" + feedrate + "\n"
   	for(j=1;j<smooth[i].length;j++){
	      g+="g1x"+(((smooth[i][j].x)-xmin)/sf).toFixed(3) +"y"+ (((ymax-ymin)-((smooth[i][j].y))+ymin)/sf).toFixed(3) + "z-" + (min_depth+(z[i][j].z)).toFixed(3) + "\n"
		}
	g+="g0z2\n"
}

g+="m5\n"
g+="m30\n"

//console.log(g)

fabmo.submitJob({
   file : g,
   filename : "sketch.g",
   name : "SKETCH",
   description : ""
});


g=""

}


$('.menu-icon').click(function(){
    if ($('.inputContainer').data('open')== 'true'){
        $('.inputContainer').css('right', '-1000px');
        $('.inputContainer').data('open', 'false');
    } else {
        $('.inputContainer').css('right', '10px');
        $('.inputContainer').data('open', 'true');
    }
});


function toggleFullScreen() {
  if (!document.fullscreenElement &&    // alternative standard method
      !document.mozFullScreenElement && !document.webkitFullscreenElement) {  // current working methods
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    } else if (document.documentElement.mozRequestFullScreen) {
      document.documentElement.mozRequestFullScreen();
    } else if (document.documentElement.webkitRequestFullscreen) {
      document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
    }
  } else {
    if (document.cancelFullScreen) {
      document.cancelFullScreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.webkitCancelFullScreen) {
      document.webkitCancelFullScreen();
    }
  }
}


</script>


</body>
</html>

