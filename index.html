<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">

<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
<script src="js/simplify.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script src="js/control.js"></script>
<script src="js/config.js"></script>
<script>
$(document).on("mobileinit", function() {
console.log("mobileinit")
});
</script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<style>


canvas{
	position: absolute;
	left: 0px;
	bottom: 0px;
}


.ui-loader {
  display: none !important;
}


</style>

</head>

<body onload="draw();">

<input id="input_submit" type="button" value="SUBMIT&#x00A;JOB" onclick="make()"/>

<canvas id="myCanvas"></canvas>

<script>

var g = ""
var points = []
var smooth = []
var n = 0
var curve = []
var timer
var sketch = false


function makesmooth(){

smooth=[]

//simplify
for(i=0;i<points.length;i++){
smooth.push([])
points[i]=simplify(points[i], 3, true)
}
curve=points

//CHAIKIN'S ALGORITHM

while(n<3){

for (i=0;i<curve.length;i++) {
	smooth[i].push(curve[i][0])
	for(j=0;j<curve[i].length-1;j++){
	var p0 = curve[i][j]
	var p1 = curve[i][j+1]
	var p0x = p0.x,
		 p0y = p0.y,
		 p1x = p1.x,
	    p1y = p1.y
	    smooth[i].push({x:(0.75*p0x+0.25*p1x),y:(0.75*p0y+0.25*p1y)})
	    smooth[i].push({x:(0.25*p0x+0.75*p1x),y:(0.25*p0y+0.75*p1y)})

	}
	smooth[i].push(curve[i][curve[i].length-1])
}

curve=smooth
smooth=[]
n++
for(i=0;i<curve.length;i++){
	smooth.push([])
}


}


n=0
smooth=curve
draw()
}

function draw(){

c = document.getElementById("myCanvas");
ctx = c.getContext("2d");

ctx.canvas.height = $(window).height()-5
ctx.canvas.width = $(window).width()-6

ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

ctx.lineWidth = 6;
ctx.strokeStyle = "#6495ed"
ctx.beginPath();
ctx.lineJoin="round"
ctx.lineCap="round"

if(points.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
			if(j==0){
			ctx.moveTo(smooth[i][j].x,smooth[i][j].y)			
			}
			else{
			ctx.lineTo(smooth[i][j].x,smooth[i][j].y)
			}
		}
		ctx.stroke()
	}
	
}



ctx.lineWidth = 1;
ctx.strokeStyle = "#000"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
		   ctx.beginPath();
			ctx.arc(smooth[i][j].x,smooth[i][j].y,2,0,2*Math.PI);
			ctx.stroke()
		}
	}
	
}

ctx.lineWidth = 6;
}



$("#myCanvas").bind('vmousedown', function(e) {
	ctx.moveTo(e.clientX,e.clientY)
	sketch=true
	points.push([])
	ctx.strokeStyle = "#4169e1"
	points[points.length-1].push({x:e.clientX,y:e.clientY})
	e.preventDefault();
});


$("#myCanvas").bind('vmousemove', function(e) {
	if((sketch==true) && (typeof e.clientX != 'undefined')) {
		ctx.lineTo(e.clientX,e.clientY)
	   points[points.length-1].push({x:e.clientX,y:e.clientY})
	   ctx.stroke()
	}
	e.preventDefault();
});


$("#myCanvas").bind('vmouseup', function(e) {
	sketch=false
	makesmooth()
	e.preventDefault();
});

$( "#myCanvas" ).dblclick(function(e) {
   points=[]
   makesmooth()
});


$("#input_tool").on("change", function(){
	 tool=parseFloat(document.getElementById("input_tool").value)
	 if(isNaN(tool)==true){
    	tool=0
    	document.getElementById('input_tool').value=tool
    }
    else{
    	tool=(tool/2)
    }
    
    if(tool<xmin){    
    	tool=xmin
    	document.getElementById('input_tool').value=tool*2    	   
    }
    else if(tool<ymin){    
    	tool=ymin
    	document.getElementById('input_tool').value=tool*2  	   
    }
   
    makeFrame(radius)
})


$(window).resize(function(){

	draw()
}); 

function make(){


var material = {feed:500,plunge:200}
var pass = 1
var pass_no=1
var pass_depth=1


g+="g21\n"
g+="g0z3\n"
//g+="m3\n"
g+="m4\n"
g+="g4p2\n"


while(pass<=pass_no){
   
   for(i=0;i<points.length;i++){
   	g+="g0x"+((points[i][0].x)/5).toFixed(3) +"y"+ ((points[i][0].x)/5).toFixed(3) + "\n"
   	g+="g1z-1f200\n"
   	g+="g1f400\n"
   	for(j=1;j<points[i].length;j++){
	      g+="g1x"+((points[i][j].x)/5).toFixed(3) +"y"+ ((points[i][j].x)/5).toFixed(3) + "\n"
		}
		g+="g0z3\n"
   }
   pass++
}

g+="m5\n"
g+="m30\n"

console.log(g)

/*
fabmo.submitJob({
   file : g,
   filename : 'sketch.g',
   name : "SKETCH",
   description : "mm" 
});
*/

g=""

}

</script>


</body>
</html>

