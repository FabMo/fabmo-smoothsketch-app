<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">

<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
<script src="js/simplify.js"></script>
<script src="js/default_sketch.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script>
$(document).on("mobileinit", function() {
	console.log("mobileinit")
});
</script>
<script>
    $(document).bind('mobileinit',function(){
        $.mobile.changePage.defaults.changeHash = false;
        $.mobile.hashListeningEnabled = false;
        $.mobile.pushStateEnabled = false;
    });
</script> 
<script src="js/jquery.mobile-1.4.5.js"></script>


</head>

<body onload="clear();">

<canvas id="myCanvas"></canvas>

<div class='submitContainer'>
    <input id="input_submit" type="button" value="SUBMIT JOB" onclick="make()"/>
</div>
<img class="clear-icon" src="css/trash.png">
<img class="menu-icon" src="css/menu.png">
<div class="inputContainer">
    <label for="gloss">Gloss</label>
    <input type="number" name="gloss" class="gloss" id="gloss" placeholder="Gloss" value="3" min="0" max = "10" step="1"/>
    <label for="width">Canvas Width (X)</label>
    <input type="number" name="width" class="width" placeholder="Canvas Width (X)" value="4"/>
    <label for="width">Canvas Height (Y)</label>
    <input type="number" name="height"class="height" placeholder="Canvas Height (Y)" value="3"/>
    <label for="width">Cut Depth</label>
    <input type="number" name="depth"class="depth"  placeholder="Cut Depth" value="-0.04"/>
</div>
<script>

//hard coded settings
// Bill's mods

var SizeX = $('.width').val();
var SizeY = $('.height').val();
var CutDepth = $('.depth').val();

$('.width').change(function(){
    SizeX = $('.width').val();
});

$('.height').change(function(){
    SizeY = $('.height').val();
});

$('.depth').change(function(){
    CutDepth = $('.depth').val();
});

$('.inputContainer').data('open', 'false');
//variables for setting mins and maxs
var MinX = 100000
var MaxX = -100000
var MinY = 100000
var MaxY = -100000
var DeltaX 
var DeltaY

// end Bill's mods
var SafeZ = 0.2
var g = ""
var points = []
var smooth = []
var endpts = []
var n = 0

var sketch = false
var animation = true

function makeSmooth(){

//console.log(points)
//join

if(points[points.length-1].length>0){
	endpts.push([points[points.length-1][0]])
	endpts[endpts.length-1].push(points[points.length-1][points[points.length-1].length-1])
}

if((Math.abs(endpts[endpts.length-1][0].x-endpts[endpts.length-1][1].x)<=15) && (Math.abs(endpts[endpts.length-1][0].y-endpts[endpts.length-1][1].y)<=15)){

	endpts[endpts.length-1][1]=endpts[endpts.length-1][0]
	points[points.length-1].push(endpts[endpts.length-1][0])
	endpts.pop()
}

else{

for(i=endpts.length-2;i>=0;i--){

	if((Math.abs(endpts[endpts.length-1][0].x-endpts[i][0].x)<=15) && (Math.abs(endpts[endpts.length-1][0].y-endpts[i][0].y)<=15)){
		endpts[endpts.length-1][0]=endpts[i][0]
		points[points.length-1].splice(0,0,endpts[i][0])
	}
	
	if((Math.abs(endpts[endpts.length-1][1].x-endpts[i][1].x)<=15) && (Math.abs(endpts[endpts.length-1][1].y-endpts[i][1].y)<=15)){
		endpts[endpts.length-1][1]=endpts[i][1]
		points[points.length-1].push(endpts[i][1])
	}
	
	if((Math.abs(endpts[endpts.length-1][1].x-endpts[i][0].x)<=15) && (Math.abs(endpts[endpts.length-1][1].y-endpts[i][0].y)<=15)){
		endpts[endpts.length-1][1]=endpts[i][0]
		points[points.length-1].push(endpts[i][0])
	}
	
	if((Math.abs(endpts[endpts.length-1][0].x-endpts[i][1].x)<=15) && (Math.abs(endpts[endpts.length-1][0].y-endpts[i][1].y)<=15)){
		endpts[endpts.length-1][0]=endpts[i][1]
		points[points.length-1].splice(0,0,endpts[i][1])
	}

}


}

var g = (parseInt(document.getElementById("gloss").value))
//simplify


points[points.length-1]=simplify(points[points.length-1], (g), true)
curve=points[points.length-1]
smooth.push([])

if(curve.length==1){
	smooth[points.length-1].push(curve[0])
}

//CHAIKIN'S ALGORITHM
if(g>6){
	g=6
}

if(curve.length>1){

	while(n<(g)){
		smooth[points.length-1].push(curve[0])
		for(i=0;i<curve.length-1;i++){
			var p0 = curve[i]
			var p1 = curve[i+1]
			var p0x = p0.x,
				p0y = p0.y,
				p1x = p1.x,
			    p1y = p1.y
				
				//Bill's mods
		if (p0x > MaxX){
            MaxX = p0x
        }
        else if (p0x < MinX) {
            MinX = p0x
        }
        else if (p0y > MaxY){
            MaxY = p0y 
        }
        else if (p0y < MinY) {
            MinY = p0y 
        };
		//end bill's mods
			smooth[points.length-1].push({x:(0.75*p0x+0.25*p1x),y:(0.75*p0y+0.25*p1y)})
			smooth[points.length-1].push({x:(0.25*p0x+0.75*p1x),y:(0.25*p0y+0.75*p1y)})
		}
		smooth[points.length-1].push(curve[curve.length-1])
		curve=smooth[points.length-1]
		smooth[points.length-1]=[]
		n++
	}
}

n=0
smooth[points.length-1]=curve

//console.log(smooth)

draw()

}

function draw(){

c = document.getElementById("myCanvas")
ctx = c.getContext("2d")

ctx.canvas.height = $(window).height()
ctx.canvas.width = $(window).width()

ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height)

ctx.lineWidth = 6;

if($('.inputContainer').data('open')== 'true'){
	ctx.strokeStyle = "#aaa"
}
else{
	ctx.strokeStyle = "#6495ed"
}

ctx.beginPath();
ctx.lineJoin="round"
ctx.lineCap="round"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
			if(j==0){
			ctx.moveTo(smooth[i][j].x,smooth[i][j].y)			
			}
			else{
			ctx.lineTo(smooth[i][j].x+0.001,smooth[i][j].y)
			}
		}
		ctx.stroke()
	}
	
}

//display points
/*
ctx.lineWidth = 1;
ctx.strokeStyle = "#000"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
		   ctx.beginPath();
			ctx.arc(smooth[i][j].x,smooth[i][j].y,2,0,2*Math.PI);
			ctx.stroke()
		}
	}
	
}
*/

	///////////////////////////////////////////////
	if($('.inputContainer').data('open')== 'true'){
		ctx.lineWidth = 1;
		ctx.strokeStyle = "#aaa"
		ctx.fillStyle = "#aaa"

		ctx.beginPath()
		ctx.moveTo(MinX,MinY)
		ctx.lineTo(MinX,MaxY)
		ctx.lineTo(MaxX,MaxY)
		ctx.stroke()

		ctx.beginPath()
		ctx.arc(MinX,MinY,2,0,2*Math.PI);
		ctx.fill()
	
		ctx.beginPath()
		ctx.arc(MinX,MaxY,2,0,2*Math.PI);
		ctx.fill()

		ctx.beginPath()
		ctx.arc(MaxX,MaxY,2,0,2*Math.PI);
		ctx.fill()

		ctx.font = "22px Arial"
		if((Math.abs(MaxX-MinX))>(Math.abs(MaxY-MinY)) && ((((Math.abs(MaxY-MinY))/(Math.abs(MaxX-MinX)))*4)<3) ){
			ctx.fillText( '4\"',MinX+((MaxX-MinX)/2),MaxY+30) //x
	
			var x = (((Math.abs(MaxY-MinY))/(Math.abs(MaxX-MinX)))*4).toFixed(1)		
			ctx.fillText( (x + '\"'),MinX-50,MinY+((MaxY-MinY)/2)) //y
		}
		else{
			ctx.fillText( '3\"',MinX-30,MinY+((MaxY-MinY)/2)) //y

			var y = (((Math.abs(MaxX-MinX))/(Math.abs(MaxY-MinY)))*3).toFixed(1)
			ctx.fillText( (y + '\"'),MinX+((MaxX-MinX)/2),MaxY+30) //x	
		}
	}
//

ctx.lineWidth = 6;
ctx.strokeStyle = "#6495ed"

}

$("#myCanvas").bind('vmousedown', function(e) {

	if($('.inputContainer').data('open')=='true'){
		$('.inputContainer').css('right', '-1000px');
		$('.inputContainer').data('open', 'false');
		draw()
	}

	e.preventDefault()
	if(animation == true){
		turnOffAnimation()
	}

	if($('.inputContainer').data('open')=='false'){
		points.push([])
		ctx.strokeStyle = "#4169e1"
		points[points.length-1].push({x:e.clientX,y:e.clientY})
		sketch=true
	}
	
});


$("#myCanvas").bind('vmousemove', function(e) {

	if((sketch==true) && (typeof e.clientX != 'undefined')) {
		

		// find min and max values
		/*Bill's mods
		if (e.clientX > MaxX){
            MaxX = e.clientX 
        }
        else if (e.clientX < MinX) {
            MinX = e.clientX
        }
        else if (e.clientY > MaxY){
            MaxY = e.clientY 
        }
        else if (e.clientY < MinY) {
            MinY = e.clientY 
        };
		//end bill's mods
		*/
		
		if(points[points.length-1].length==1){
			ctx.beginPath()
			ctx.moveTo(e.clientX,e.clientY)
		}		
		ctx.lineTo(e.clientX,e.clientY)
	   points[points.length-1].push({x:e.clientX,y:e.clientY})
	   ctx.stroke()

	}
	e.preventDefault()
});


$("#myCanvas").bind('vmouseup', function(e) {
	if(sketch==true) {
		sketch=false
		makeSmooth()
	}
	//console.log(points)

	e.preventDefault()
});


$(window).resize(function(){
	clear()
}); 

function clear(){
   MinX = 100000
   MaxX = -100000
   MinY = 100000
   MaxY = -100000
   points=[]
   smooth=[]
   draw()


i=0
j=0
if(animation==true){
	ctx.translate(ctx.canvas.width/2,ctx.canvas.height/2)
	ctx.moveTo(default_sketch[0][0].x,default_sketch[0][0].y)
animate()
}

}

function animate () {
   if(animation==true){       
   setTimeout(function () {    
      ctx.lineTo(default_sketch[i][j].x,default_sketch[i][j].y)
		if(sketch==false){
			ctx.stroke()    
		}
      j=j+2;                     
      if (j < default_sketch[i].length) {            
         animate()             
      }
		else if((j>=default_sketch[i].length) && (i<default_sketch.length-1)) {
			i++
			j=0
			ctx.moveTo(default_sketch[i][j].x,default_sketch[i][j].y)
			animate()
		}

                        
   }, 1)	
	}
	if(animation==true){



		setTimeout("turnOffAnimation();",3000)
	}

}


function turnOffAnimation(){
	
	if(animation==true){
		animation = false
		clear()
	}
}

function make(){

//calculate scaling
//Bill's mods
    var Scale
    
    DeltaX = (MaxX - MinX)
    DeltaY = (MaxY - MinY)
    //console.log("DeltaX = " + DeltaX)
    //console.log("DeltaY = " + DeltaY)
    var ScaleFactorX = SizeX / DeltaX
    var ScaleFactorY = SizeY / DeltaY
    if (ScaleFactorX < ScaleFactorY) {
        Scale = ScaleFactorX
    }
    else {
        Scale = ScaleFactorY
    }
	//console.log(Scale)
	//end Bill's mods

var material = {feed:500,plunge:200}
var pass = 1
var pass_no=1
var pass_depth=1

//add test for inch/metric based on size of drawing
//Bill's mod

if (SizeX > 6){
	g+="g21\n"}
	else{
	g+="g20\n"
	};
	
g+="g0z " + SafeZ + "\n"

//end Bill's mods


g+="m4\n"
g+="g4p2\n"

while(pass<=pass_no){
   
   for(i=0;i<smooth.length;i++){
   
   //Bill's mods for scaling and position
   	//g+="g0x"+(smooth[i][0].x).toFixed(3) +"y"+ (smooth[i][0].y).toFixed(3) + "\n"
   	//g+="g1z-1f60\n"
   	//g+="g1f60\n"
   	//for(j=1;j<smooth[i].length;j++){
	 //     g+="g1x"+(smooth[i][j].x).toFixed(3) +"y"+ (smooth[i][j].y).toFixed(3) + "\n"
	//	}
	//	g+="g0z3\n"
	
	g+="g0x"+(((smooth[i][0].x) - MinX) * Scale) .toFixed(3)  +"y"+ ((DeltaY - ((smooth[i][0].y)- MinY)) * Scale).toFixed(3) + "\n"
   	g+="g1z " + CutDepth + "f60\n"
   	g+="g1f60\n"
   	for(j=1;j<smooth[i].length;j++){
	      g+="g1x"+(((smooth[i][j].x) - MinX) * Scale) .toFixed(3)  +"y"+ ((DeltaY - ((smooth[i][j].y) - MinY) )* Scale).toFixed(3)  + "\n"
			
		}
		g+="g0z " + SafeZ + "\n"
		
		// end Bill's mods
   }
   pass++
}

g+="m5\n"
g+="m30\n"

//console.log(g)

//define default sketch
/*
default_sketch=[]
for(i=0;i<smooth.length;i++){
	default_sketch.push(["["])
	for(j=0;j<smooth[i].length;j++){

		smooth[i][j].x = ((smooth[i][j].x) - (MinX + DeltaX/2)).toFixed(1)
		smooth[i][j].y = ((smooth[i][j].y) - (MinY+ DeltaY/2)).toFixed(1)

		default_sketch[i]+=(JSON.stringify(smooth[i][j])+",")
	}
		default_sketch[i]+=(["]"])
}

for(i=0;i<default_sketch.length;i++){
	console.log(default_sketch[i])
}
*/
//

fabmo.submitJob({
   file : g,
   filename : "sketch.g",
  name : "SKETCH",
   description : "Smooth Sketch"
});


g=""

}
$('.menu-icon').click(function(){
    if ($('.inputContainer').data('open')== 'true'){
        $('.inputContainer').css('right', '-1000px');
        $('.inputContainer').data('open', 'false');
		  draw()
    } else {
        $('.inputContainer').css('right', '10px');
        $('.inputContainer').data('open', 'true');
		  draw()
    }
});

$('.clear-icon').click(function(){
    clear();
});

</script>


</body>
</html>

