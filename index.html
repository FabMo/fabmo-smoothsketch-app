<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">

<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
<script src="js/simplify.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script>
$(document).on("mobileinit", function() {
	console.log("mobileinit")
});
</script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<style>

canvas{
	position: absolute;
	left: 0px;
	bottom: 0px;
   background: #eee;
}

</style>

</head>

<body onload="draw();">

<canvas id="myCanvas"></canvas>
<input id="input_submit" type="button" value="SUBMIT JOB" onclick="make()"/>

<script>

//hard coded settings
// Bill's mods
var SizeX = 4
var SizeY = 3
var CutDepth = -0.04
var SafeZ = 0.2

//variables for setting mins and maxs
var MinX = 100000
var MaxX = -100000
var MinY = 100000
var MaxY = -100000
var DeltaX 
var DeltaY

// end Bill's mods

var g = ""
var points = []
var smooth = []
var n = 0
var curve = []
var timer
var sketch = false

function makeSmooth(){

//join

if(( (Math.abs((points[points.length-1][0].x)-(points[points.length-1][points[points.length-1].length-1].x))) <=20) && ( (Math.abs((points[points.length-1][0].y)-(points[points.length-1][points[points.length-1].length-1].y))) <=20)){

points[points.length-1].push(points[points.length-1][0])

}


//simplify

points[points.length-1]=simplify(points[points.length-1], 3, true)
curve=points[points.length-1]
smooth.push([])

if(curve.length==1){
	smooth[points.length-1].push(curve[0])
}

//CHAIKIN'S ALGORITHM

if(curve.length>1){

	while(n<3){
		smooth[points.length-1].push(curve[0])
		for(i=0;i<curve.length-1;i++){
			var p0 = curve[i]
			var p1 = curve[i+1]
			var p0x = p0.x,
				p0y = p0.y,
				p1x = p1.x,
			    p1y = p1.y
			smooth[points.length-1].push({x:(0.75*p0x+0.25*p1x),y:(0.75*p0y+0.25*p1y)})
			smooth[points.length-1].push({x:(0.25*p0x+0.75*p1x),y:(0.25*p0y+0.75*p1y)})
		}
		smooth[points.length-1].push(curve[curve.length-1])
		curve=smooth[points.length-1]
		smooth[points.length-1]=[]
		n++
	}
	
}

n=0
smooth[points.length-1]=curve

draw()

}

function draw(){

c = document.getElementById("myCanvas");
ctx = c.getContext("2d");

ctx.canvas.height = $(window).height()-5
ctx.canvas.width = $(window).width()-6

ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

ctx.lineWidth = 6;
ctx.strokeStyle = "#6495ed"
ctx.beginPath();
ctx.lineJoin="round"
ctx.lineCap="round"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
			if(j==0){
			ctx.moveTo(smooth[i][j].x,smooth[i][j].y)			
			}
			else{
			ctx.lineTo(smooth[i][j].x,smooth[i][j].y)
			}
		}
		ctx.stroke()
	}
	
}

ctx.lineWidth = 1;
ctx.strokeStyle = "#000"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
		   ctx.beginPath();
			ctx.arc(smooth[i][j].x,smooth[i][j].y,2,0,2*Math.PI);
			ctx.stroke()
		}
	}
	
}

ctx.lineWidth = 6;

}

$("#myCanvas").bind('vmousedown', function(e) {
//	console.log(e.type)
	ctx.beginPath();
	ctx.moveTo(e.clientX,e.clientY)
	sketch=true
	points.push([])
	ctx.strokeStyle = "#4169e1"
	points[points.length-1].push({x:e.clientX,y:e.clientY})
	e.preventDefault()
});


$("#myCanvas").bind('vmousemove', function(e) {
	if((sketch==true) && (typeof e.clientX != 'undefined')) {
		ctx.lineTo(e.clientX,e.clientY)
		
		// find min and max values
		//Bill's mods
		if (e.clientX > MaxX){
            MaxX = e.clientX
        }
        else if (e.clientX < MinX) {
            MinX = e.clientX
        }
        else if (e.clientY > MaxY){
            MaxY = e.clientY 
        }
        else if (e.clientY < MinY) {
            MinY = e.clientY 
        };
		//end bill's mods
	   points[points.length-1].push({x:e.clientX,y:e.clientY})
	   ctx.stroke()
	}
	e.preventDefault()
});


$("#myCanvas").bind('vmouseup', function(e) {
	sketch=false
	makeSmooth()
	e.preventDefault()
});

$( "#myCanvas" ).dblclick(function(e) {
   points=[]
   smooth=[]
   draw()
});


$(window).resize(function(){

	draw()
}); 

function make(){

//calculate scaling
//Bill's mods
    var Scale
    
    DeltaX = MaxX - MinX
    DeltaY = MaxY - MinY
    console.log("DeltaX = " + DeltaX)
    console.log("DeltaY = " + DeltaY)
    
    var ScaleFactorX = SizeX / DeltaX
    var ScaleFactorY = SizeY / DeltaY
    if (ScaleFactorX < ScaleFactorY) {
        Scale = ScaleFactorX
    }
    else {
        Scale = ScaleFactorY
    }
	
	//end Bill's mods

var material = {feed:500,plunge:200}
var pass = 1
var pass_no=1
var pass_depth=1

//add test for inch/metric based on size of drawing
//Bill's mod

if (SizeX > 6){
	g+="g21\n"}
	else{
	g+="g20\n"
	};
	
g+="g0z " + SafeZ + "\n"

//end Bill's mods


g+="m4\n"
g+="g4p2\n"

while(pass<=pass_no){
   
   for(i=0;i<smooth.length;i++){
   
   //Bill's mods for scaling and position
   	//g+="g0x"+(smooth[i][0].x).toFixed(3) +"y"+ (smooth[i][0].y).toFixed(3) + "\n"
   	//g+="g1z-1f60\n"
   	//g+="g1f60\n"
   	//for(j=1;j<smooth[i].length;j++){
	 //     g+="g1x"+(smooth[i][j].x).toFixed(3) +"y"+ (smooth[i][j].y).toFixed(3) + "\n"
	//	}
	//	g+="g0z3\n"
	
	g+="g0x"+(((smooth[i][0].x) - MinX) * Scale) .toFixed(3)  +"y"+ (SizeY - (((smooth[i][0].y) - MinY) * Scale)).toFixed(3) + "\n"
   	g+="g1z " + CutDepth + "f60\n"
   	g+="g1f60\n"
   	for(j=1;j<smooth[i].length;j++){
	      g+="g1x"+(((smooth[i][j].x) - MinX) * Scale) .toFixed(3)  +"y"+ (SizeY - (((smooth[i][j].y) - MinY) * Scale)).toFixed(3)  + "\n"
		}
		g+="g0z " + SafeZ + "\n"
		
		// end Bill's mods
   }
   pass++
}

g+="m5\n"
g+="m30\n"

//console.log(g)

fabmo.submitJob({
   file : g,
   filename : "sketch.g",
   name : "SKETCH",
   description : ""
});


g=""

}

</script>


</body>
</html>

