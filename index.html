<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">

<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/libs/fabmo.js"></script>
<script src="js/simplify.js"></script>
    <script type="text/javascript">
        var fabmo = new FabMoDashboard();
    </script>
<script>
$(document).on("mobileinit", function() {
	console.log("mobileinit")
});
</script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<style>

canvas{
	position: absolute;
	left: 0px;
	bottom: 0px;
   background: #555;
}



</style>

</head>

<body onload="draw();">

<canvas id="myCanvas"></canvas>
<input id="input_submit" type="button" value="SUBMIT JOB" onclick="make()"/>

<script>

var g = ""
var points = []
var smooth = []
var curve = []
var endpts = []
var connect = []
var n = 0
var sketch = false
var ts = 0

var xmin
var xmax
var ymin
var ymax

function makeSmooth(){

if(points[points.length-1].length>0){

	endpts.push([points[points.length-1][0]])
	endpts[points.length-1].push(points[points.length-1][points[points.length-1].length-1])
//	console.log(endpts)

}

//connect=[]

for(i=endpts.length-1;i>=0;i--){

	if((Math.abs(endpts[endpts.length-1][0].x-endpts[i][0].x)<=20) && (Math.abs(endpts[endpts.length-1][0].y-endpts[i][0].y)<=20)){
		connect.push([endpts[endpts.length-1][0],endpts[i][0]])
	}
	
	if((Math.abs(endpts[endpts.length-1][1].x-endpts[i][1].x)<=20) && (Math.abs(endpts[endpts.length-1][1].y-endpts[i][1].y)<=20)){
		connect.push([endpts[endpts.length-1][1],endpts[i][1]])
	}
	
	if((Math.abs(endpts[endpts.length-1][1].x-endpts[i][0].x)<=20) && (Math.abs(endpts[endpts.length-1][1].y-endpts[i][0].y)<=20)){
		connect.push([endpts[endpts.length-1][1],endpts[i][0]])
	}
	
	if((Math.abs(endpts[endpts.length-1][0].x-endpts[i][1].x)<=20) && (Math.abs(endpts[endpts.length-1][0].y-endpts[i][1].y)<=20)){
		connect.push([endpts[endpts.length-1][0],endpts[i][1]])
	}


}


//simplify

points[points.length-1]=simplify(points[points.length-1], 5, true)

curve=points[points.length-1]
smooth.push([])

if(curve.length==1){
	smooth[points.length-1].push(curve[0])
}

//CHAIKIN'S ALGORITHM

if(curve.length>2){

	while(n<=3){
		smooth[points.length-1].push(curve[0])
		for(i=0;i<curve.length-1;i++){
			var p0 = curve[i]
			var p1 = curve[i+1]
			var p0x = p0.x,
				 p0y = p0.y,
				 p1x = p1.x,
			    p1y = p1.y
			smooth[points.length-1].push({x:(0.75*p0x+0.25*p1x),y:(0.75*p0y+0.25*p1y)})
			smooth[points.length-1].push({x:(0.25*p0x+0.75*p1x),y:(0.25*p0y+0.75*p1y)})
		}
		smooth[points.length-1].push(curve[curve.length-1])
		curve=smooth[points.length-1]
		smooth[points.length-1]=[]
		n++
	}
	
}

n=0

smooth[points.length-1]=curve

if(typeof xmin == 'undefined'){

	xmin = Math.min.apply(this,$.map(curve, function(o){ return o.x; }))
	xmax = Math.max.apply(this,$.map(curve, function(o){ return o.x; }))
	ymin = Math.min.apply(this,$.map(curve, function(o){ return o.y; }))
	ymax = Math.max.apply(this,$.map(curve, function(o){ return o.y; }))

}

else{

	if((Math.min.apply(this,$.map(curve, function(o){ return o.x; })))<xmin){
		xmin = Math.min.apply(this,$.map(curve, function(o){ return o.x; }))
	}
	if((Math.max.apply(this,$.map(curve, function(o){ return o.x; })))>xmax){
		xmax = Math.max.apply(this,$.map(curve, function(o){ return o.x; }))
	}
	if((Math.min.apply(this,$.map(curve, function(o){ return o.y; })))<ymin){
		ymin = Math.min.apply(this,$.map(curve, function(o){ return o.y; }))
	}
	if((Math.max.apply(this,$.map(curve, function(o){ return o.y; })))>ymax){
		ymax = Math.max.apply(this,$.map(curve, function(o){ return o.y; }))
	}
	
}

draw()

}

function draw(){

c = document.getElementById("myCanvas");
ctx = c.getContext("2d")

ctx.canvas.height = $(window).height()
ctx.canvas.width = $(window).width()

ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

ctx.beginPath()
ctx.fillStyle = "#333"
ctx.rect(xmin-10,ymin-10,xmax+20-xmin,ymax+20-ymin)
ctx.fill()

ctx.lineWidth = 10
ctx.strokeStyle = "#6495ed"
ctx.beginPath()
ctx.lineJoin="round"
ctx.lineCap="round"

if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
			if(j==0){
			ctx.moveTo(smooth[i][j].x,smooth[i][j].y)			
			}
			else{
			ctx.lineTo(smooth[i][j].x,smooth[i][j].y)
			}
		}
		ctx.stroke()
	}
	
}

ctx.lineWidth = 1

//72dpi

ctx.beginPath()
ctx.strokeStyle = "#ccc"

ctx.rect(xmin-10,ymin-10,xmax+20-xmin,ymax+20-ymin)
//ctx.rect((ctx.canvas.width/2)-(288),(ctx.canvas.height/2)-(216),(648),(432))

ctx.stroke()

ctx.strokeStyle = "#555"
/*
if(smooth.length>0){
	for(i=0;i<smooth.length;i++){
		for(j=0;j<smooth[i].length;j++){
		   ctx.beginPath();
			ctx.arc(smooth[i][j].x,smooth[i][j].y,2,0,2*Math.PI)
			ctx.stroke()
		}
	}	
}
*/
ctx.lineWidth = 1
ctx.fillStyle="#ff00ff"
ctx.strokeStyle = "#eee"
for(i=0;i<connect.length;i++){

ctx.beginPath()	
	ctx.moveTo(connect[i][0].x,connect[i][0].y)
	ctx.arc(connect[i][0].x,connect[i][0].y,3,0,2*Math.PI)
	ctx.lineTo(connect[i][1].x,connect[i][1].y)
	ctx.arc(connect[i][1].x,connect[i][1].y,3,0,2*Math.PI)
ctx.fill()
ctx.stroke()


}


ctx.beginPath()
ctx.strokeStyle = "#555"
ctx.fillStyle = "#fff000"
//ctx.arc((ctx.canvas.width/2)-(288),(ctx.canvas.height/2)+(216),3,0,2*Math.PI)
ctx.arc(xmin-10,ymax+10,4,0,2*Math.PI)
ctx.fill()
//ctx.stroke()


}

$("#myCanvas").bind('vmousedown', function(e) {
//	console.log(e.type)
	ctx.beginPath();
	ctx.lineWidth = 10;
	ctx.moveTo(e.clientX,e.clientY)
	sketch=true
	points.push([])
	ctx.strokeStyle = "#4169e1"
	points[points.length-1].push({x:e.clientX,y:e.clientY})
	e.preventDefault()
});


$("#myCanvas").bind('vmousemove', function(e) {
	if((sketch==true) && (typeof e.clientX != 'undefined')) {
		ctx.lineTo(e.clientX,e.clientY)
	   points[points.length-1].push({x:e.clientX,y:e.clientY})
	   ctx.stroke()
	}
	e.preventDefault()
});


$("#myCanvas").bind('vmouseup', function(e) {
	sketch=false
	makeSmooth()
	e.preventDefault()
});

$( "#myCanvas" ).bind('tap', function(e) {
	ts = e.timeStamp - ts
	if(ts<250){
		clear()
	}
	ts = e.timeStamp
});

$(window).on("orientationchange", function() {
	draw()
});


$(window).resize(function(){

	draw()
}); 

function clear(){

	xmin = undefined
	xmax = undefined
	ymin = undefined
	ymax = undefined
   points=[]
   smooth=[]
   endpts=[]
   connect=[]
   draw()

}

function make(){

var material = {feed:500,plunge:200}
var pass = 1
var pass_no=1
var pass_depth=1

//scale 96dpi
var sf = ((xmax-xmin)/(25.4*(xmax-xmin)/96))


g+="g21\n"
g+="g0z3\n"
g+="m4\n"
g+="g4p2\n"

while(pass<=pass_no){
   
   for(i=0;i<smooth.length;i++){
   	g+="g0x"+(((smooth[i][0].x)-xmin)/sf).toFixed(3) +"y"+ (((ymax-ymin)-((smooth[i][0].y))+ymin)/sf).toFixed(3) + "\n"
   	g+="g1z-1f200\n"
   	g+="g1f400\n"
   	for(j=1;j<smooth[i].length;j++){
	      g+="g1x"+(((smooth[i][j].x)-xmin)/sf).toFixed(3) +"y"+ (((ymax-ymin)-((smooth[i][j].y))+ymin)/sf).toFixed(3) + "\n"
		}
		g+="g0z3\n"
   }
   pass++
}

g+="m5\n"
g+="m30\n"

//console.log(g)

fabmo.submitJob({
   file : g,
   filename : "sketch.g",
   name : "SKETCH",
   description : ""
});


g=""

}

</script>


</body>
</html>

